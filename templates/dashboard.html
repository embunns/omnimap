<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <title>OmniMap - Dashboard</title>
</head>

<body style="background: #fee8e9;">

    {% include 'partials/sidebar.html' %}

    <section id="content">
        {% include 'partials/navbar.html' %}

        <main class="omnimap-content-wrapper">
            <div class="btnChatbot">
                <a href="{{ url_for('chatbot') }}"><img src="{{ url_for('static', filename='img/chatbot.svg') }}" alt=""></a>
            </div>

            <div class="container mb-4">
                <div class="row">
                    <div class="col-12">
                        <div class="omni-welcome-banner">
                            <div class="row align-items-center">
                                <div class="col-lg-7 col-md-6">
                                    <h1 class="welcome-title">Welcome, {{ user.nama.split()[0] }}!</h1>
                                    <p class="welcome-description">Temukan insight kepribadianmu dan lihat rekomendasi kegiatan yang paling cocok untukmu.</p>
                                    <a href="{{ url_for('hasil_tes') }}" class="omni-welcome-btn">
                                        <i class="bi bi-pencil me-2"></i>
                                        Pelajari hasil tes & analisis OMNI
                                    </a>
                                </div>
                                <div class="col-lg-5 col-md-6 text-center">
                                    <img src="{{ url_for('static', filename='img/robot-5.svg') }}" alt="Robot" class="welcome-robot-img">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container mb-4">
                <div class="row g-3">
                    <div class="col-md-4 col-sm-6">
                        <div class="card-stats-hasil summary-card">
                            <div class="row align-items-center">
                                <div class="col-8">
                                    <small>Skor Rata-rata</small>
                                    <h4>{{ user.skor_rata_rata if user.skor_rata_rata else '-' }}</h4>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="bg-icon-hasil-tes">
                                        <i class="bi bi-pencil-fill" style="color: #c62828; font-size: 24px;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <div class="card-stats-hasil summary-card">
                            <div class="row align-items-center">
                                <div class="col-8">
                                    <small>Status Tes</small>
                                    <h4>{{ user.status_tes }}</h4>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="bg-icon-hasil-tes">
                                        <i class="bi bi-folder-fill" style="color: #c62828; font-size: 24px;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <div class="card-stats-hasil summary-card">
                            <div class="row align-items-center">
                                <div class="col-8">
                                    <small>Rekomendasi</small>
                                    <h4 id="rekomendasiCount">-</h4>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="bg-icon-hasil-tes">
                                        <i class="bi bi-search" style="color: #c62828; font-size: 24px;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if user.status_tes == 'Selesai' %}
            <!-- Show if test completed -->
            <div class="container mb-4">
                <div class="row">
                    <div class="col-12">
                        <div class="card-stats-hasil">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="fw-bold mb-0">Dimensi Kepribadian</h4>
                                <a href="{{ url_for('hasil_tes') }}" class="text-danger text-decoration-none fw-bold" style="font-size: 0.9rem;">
                                    Lihat Detail <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                            <div class="personality-dimensions">
                                <div class="omni-personality-progress-item">
                                    <div class="omni-personality-progress-row">
                                        <span class="omni-personality-label">Extraversion</span>
                                        <div class="omni-personality-progress-wrapper">
                                            <div class="progress omni-personality-progress-track">
                                                <div class="progress-bar omni-personality-progress-fill" role="progressbar" style="width: {{ user.extraversion_t|default(0) }}%"></div>
                                            </div>
                                        </div>
                                        <span class="omni-personality-score">{{ user.extraversion_t|default(0)|round|int }}</span>
                                    </div>
                                </div>
                                <div class="omni-personality-progress-item">
                                    <div class="omni-personality-progress-row">
                                        <span class="omni-personality-label">Agreeableness</span>
                                        <div class="omni-personality-progress-wrapper">
                                            <div class="progress omni-personality-progress-track">
                                                <div class="progress-bar omni-personality-progress-fill" role="progressbar" style="width: {{ user.agreeableness_t|default(0) }}%"></div>
                                            </div>
                                        </div>
                                        <span class="omni-personality-score">{{ user.agreeableness_t|default(0)|round|int }}</span>
                                    </div>
                                </div>
                                <div class="omni-personality-progress-item">
                                    <div class="omni-personality-progress-row">
                                        <span class="omni-personality-label">Conscientiousness</span>
                                        <div class="omni-personality-progress-wrapper">
                                            <div class="progress omni-personality-progress-track">
                                                <div class="progress-bar omni-personality-progress-fill" role="progressbar" style="width: {{ user.conscientiousness_t|default(0) }}%"></div>
                                            </div>
                                        </div>
                                        <span class="omni-personality-score">{{ user.conscientiousness_t|default(0)|round|int }}</span>
                                    </div>
                                </div>
                                <div class="omni-personality-progress-item">
                                    <div class="omni-personality-progress-row">
                                        <span class="omni-personality-label">Neuroticism</span>
                                        <div class="omni-personality-progress-wrapper">
                                            <div class="progress omni-personality-progress-track">
                                                <div class="progress-bar omni-personality-progress-fill" role="progressbar" style="width: {{ user.neuroticism_t|default(0) }}%"></div>
                                            </div>
                                        </div>
                                        <span class="omni-personality-score">{{ user.neuroticism_t|default(0)|round|int }}</span>
                                    </div>
                                </div>
                                <div class="omni-personality-progress-item">
                                    <div class="omni-personality-progress-row">
                                        <span class="omni-personality-label">Openness</span>
                                        <div class="omni-personality-progress-wrapper">
                                            <div class="progress omni-personality-progress-track">
                                                <div class="progress-bar omni-personality-progress-fill" role="progressbar" style="width: {{ user.openness_t|default(0) }}%"></div>
                                            </div>
                                        </div>
                                        <span class="omni-personality-score">{{ user.openness_t|default(0)|round|int }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container mb-4">
                <div class="row">
                    <div class="col-12">
                        <div class="omni-insight-card">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-lightbulb-fill me-3" style="font-size: 2rem; flex-shrink: 0;"></i>
                                <div>
                                    <h1 class="fw-bold mb-3" style="color: #fff; font-size: 1.5rem;">Insight Kepribadian</h1>
                                    <p class="mb-3" style="opacity: 0.95; line-height: 1.6; font-size: 1rem;">
                                        Berdasarkan hasil tes OMNI kamu, kamu memiliki tingkat 
                                        {% set traits = [] %}
                                        {% if user.extraversion_t >= 60 %}{% set _ = traits.append('Extraversion') %}{% endif %}
                                        {% if user.agreeableness_t >= 60 %}{% set _ = traits.append('Agreeableness') %}{% endif %}
                                        {% if user.conscientiousness_t >= 60 %}{% set _ = traits.append('Conscientiousness') %}{% endif %}
                                        {% if user.openness_t >= 60 %}{% set _ = traits.append('Openness') %}{% endif %}
                                        {% if traits|length >= 2 %}
                                        <strong>{{ traits[0] }}</strong> dan <strong>{{ traits[1] }}</strong>
                                        {% elif traits|length == 1 %}
                                        <strong>{{ traits[0] }}</strong>
                                        {% else %}
                                        <strong>kepribadian yang seimbang</strong>
                                        {% endif %}
                                        yang tinggi. Ini menunjukkan bahwa kamu adalah pribadi yang {% if traits|length > 0 %}antusias dan bertanggung jawab{% else %}seimbang{% endif %}!
                                    </p>
                                    <div class="mt-3">
                                        {% if user.extraversion_t >= 60 %}<span class="omni-insight-badge">Ekstrovert</span>{% endif %}
                                        {% if user.agreeableness_t >= 60 %}<span class="omni-insight-badge">Ramah</span>{% endif %}
                                        {% if user.conscientiousness_t >= 60 %}<span class="omni-insight-badge">Bertanggung Jawab</span>{% endif %}
                                        {% if user.openness_t >= 60 %}<span class="omni-insight-badge">Kreatif</span>{% endif %}
                                        {% if user.neuroticism_t <= 40 %}<span class="omni-insight-badge">Stabil Emosi</span>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container">
                <div class="row">
                    <div class="col-lg-7 col-md-12 mb-4">
                        <div class="card-stats-hasil">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="fw-bold mb-0">Rekomendasi Kegiatan</h4>
                                <a href="{{ url_for('rekomendasi_kegiatan') }}" class="text-danger text-decoration-none fw-bold" style="font-size: 0.9rem;">
                                    Semua <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                            <div class="activity-recommendations" id="activityRecommendations">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5 col-md-12 mb-4">
                        <div class="card-stats-hasil">
                            <div class="d-flex align-items-center mb-4">
                                <div class="progress-icon-wrapper">
                                    <i class="bi bi-search"></i>
                                </div>
                                <h4 class="fw-bold mb-0">Progress Pengembangan Diri</h4>
                            </div>
                            <div class="self-development-progress">
                                <div class="progress-item">
                                    <div class="progress-item-label">
                                        <span>Profil Lengkap</span>
                                        <span>{{ user.progress_profil }}%</span>
                                    </div>
                                    <div class="progress-item-bar">
                                        <div class="progress-item-fill progress-green" style="width: {{ user.progress_profil }}%"></div>
                                    </div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-item-label">
                                        <span>Tes OMNI Selesai</span>
                                        <span>{{ user.progress_tes }}%</span>
                                    </div>
                                    <div class="progress-item-bar">
                                        <div class="progress-item-fill progress-blue" style="width: {{ user.progress_tes }}%"></div>
                                    </div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-item-label">
                                        <span>Eksplorasi Kegiatan</span>
                                        <span>{{ user.progress_eksplorasi }}%</span>
                                    </div>
                                    <div class="progress-item-bar">
                                        <div class="progress-item-fill progress-yellow" style="width: {{ user.progress_eksplorasi }}%"></div>
                                    </div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-item-label">
                                        <span>Bergabung dengan Kegiatan</span>
                                        <span>{{ user.progress_kegiatan }}%</span>
                                    </div>
                                    <div class="progress-item-bar">
                                        <div class="progress-item-fill progress-gray" style="width: {{ user.progress_kegiatan }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container mb-4">
                <div class="row">
                    <div class="col-lg-6 col-md-12 mb-4">
                        <div class="card-stats-hasil">
                            <h4 class="fw-bold mb-4">Kategori Kegiatan</h4>
                            <div class="chart-container-wrapper">
                                <canvas id="kategoriKegiatanChart"></canvas>
                            </div>
                            <div class="chart-legend mt-3">
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #e91e63;"></span>
                                    <span>Kepanitiaan (64%)</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #64b5f6;"></span>
                                    <span>UKM (43%)</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #ff9800;"></span>
                                    <span>Organisasi (5%)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 col-md-12 mb-4">
                        <div class="card-stats-hasil position-relative">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-emoji-smile-fill me-2" style="color: #c62828; font-size: 24px;"></i>
                                <h4 class="fw-bold mb-0">Skor Rata-rata</h4>
                            </div>
                            <div class="gauge-chart-container">
                                <canvas id="skorRataRataGauge"></canvas>
                                <div class="gauge-text-overlay">
                                    <p class="gauge-label">Skor Rata-rata kamu adalah</p>
                                    <h2 class="gauge-value">72</h2>
                                </div>
                            </div>
                            <div class="chatbot-icon-bottom">
                                <i class="bi bi-chat-dots-fill" style="color: #c62828; font-size: 20px;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Show if test NOT completed -->
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card-stats-hasil text-center" style="padding: 60px 40px; background: linear-gradient(135deg, #fff 0%, #fef5f5 100%); border: 2px dashed #c62828;">
                            <i class="bi bi-clipboard-x" style="font-size: 5rem; color: #c62828; opacity: 0.3; margin-bottom: 20px;"></i>
                            <h3 style="color: #c62828; font-weight: 700; margin-bottom: 16px;">Silakan Lakukan Tes OMNI Terlebih Dahulu!</h3>
                            <p style="color: #666; font-size: 1.1rem; margin-bottom: 30px;">
                                Untuk mendapatkan rekomendasi kegiatan yang sesuai dengan kepribadianmu, kamu perlu menyelesaikan tes OMNI terlebih dahulu.
                            </p>
                            <a href="{{ url_for('tes_omni') }}" class="btn btn-danger" style="padding: 12px 40px; font-size: 1.1rem; border-radius: 10px; font-weight: 600;">
                                <i class="bi bi-pencil-square me-2"></i>
                                Mulai Tes OMNI Sekarang
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </main>
    </section>
    {% include 'partials/logout_modal.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Load activities for recommendations
        async function loadDashboardData() {
            try {
                const res = await fetch('/api/recommended-activities');
                const data = await res.json();
                const activities = data.activities || [];
                
                // Update rekomendasi count
                document.getElementById('rekomendasiCount').textContent = data.total || activities.length || 0;
                
                // Populate activity recommendations (sorted by match_percentage)
                const activityContainer = document.getElementById('activityRecommendations');
                if (activityContainer && activities.length > 0) {
                    activityContainer.innerHTML = activities.slice(0, 2).map(a => `
                        <div class="activity-recommendation-card">
                            <div class="activity-card-header">
                                <div class="activity-title-section">
                                    <h5 class="activity-title-text">${a.nama}</h5>
                                    <p class="activity-description-text">${a.deskripsi || a.kategori}</p>
                                </div>
                                <div class="activity-badges-section">
                                    <span class="activity-tag activity-tag-red">${a.kategori}</span>
                                    <span class="activity-tag activity-tag-green">${a.match_percentage}% match</span>
                                </div>
                            </div>
                            <div class="activity-meta-info">
                                <div class="activity-meta-item">
                                    <i class="bi bi-calendar3"></i>
                                    <span>Deadline : ${a.deadline || '-'}</span>
                                </div>
                                <div class="activity-meta-item">
                                    <i class="bi bi-people"></i>
                                    <span>Peserta ${a.peserta || '0/0'}</span>
                                </div>
                                <div class="activity-meta-item">
                                    <i class="bi bi-geo-alt"></i>
                                    <span>${a.lokasi || 'Telkom University'}</span>
                                </div>
                            </div>
                            <div class="activity-progress-bar">
                                <div class="progress activity-progress-track">
                                    <div class="progress-bar activity-progress-fill" style="width: ${a.match_percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else if (activityContainer) {
                    activityContainer.innerHTML = '<p class="text-muted text-center">Belum ada rekomendasi kegiatan</p>';
                }
            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('rekomendasiCount').textContent = '0';
            }
        }

        // Load dashboard data on page load
        loadDashboardData();
    </script>
</body>

</html>